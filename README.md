# YooMoney Recurrent Payments (Demo)

Этот проект реализует систему рекуррентных платежей с поддержкой:
- создание подписок/платежей
- повторный платеж (retry) через день при неудаче
- возврат платежа
- уведомления о статусе платежа в Telegram или в консоль
- mock-платежный шлюз (имитация YooMoney), с возможностью интеграции реального API

## Требования
- Python 3.10+
- Установленные зависимости:
```bash
pip install -r requirements.txt
```

## Настройка `.env`
Создайте файл `.env` рядом с проектом:
```
DATABASE_URL=sqlite:///./payments.db
NOTIFICATION_BACKEND=console  # console | telegram
TELEGRAM_BOT_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=ид_чата
GATEWAY_MODE=mock  # mock | yoomoney
SCHEDULER_INTERVAL_SECONDS=60  # интервал планировщика
RETRY_DELAY_SECONDS=86400  # повторная попытка через день
```
> Если Telegram не нужен, оставьте `NOTIFICATION_BACKEND=console`

## Запуск проекта
```bash
python -m uvicorn app.main:app --reload
```
- Проект будет доступен на `http://127.0.0.1:8000`
- Планировщик будет проверять подписки каждые `SCHEDULER_INTERVAL_SECONDS` секунд

## Swagger UI
Перейдите в браузере:
```
http://127.0.0.1:8000/docs
```
Там можно выполнить все запросы через удобный интерфейс.

### Примеры запросов

#### 1. Создание подписки
**POST /subscribe**
```json
{
  "user_id": "test_user",
  "amount": 100,
  "currency": "RUB",
  "interval_days": 30
}
```
Ответ:
```json
{
  "subscription_id": 1
}
```

#### 2. Проверка статуса подписки и платежей
**GET /status/{subscription_id}**
Пример: `/status/1`
Ответ:
```json
{
  "subscription": {
    "id": 1,
    "user_id": "test_user",
    "amount": 100,
    "currency": "RUB",
    "active": true,
    "next_run": "2025-10-30T12:00:00"
  },
  "payments": [
    {"id": 1, "status": "succeeded", "amount": 100, "failure_reason": null, "attempts": 1}
  ]
}
```

#### 3. Возврат платежа
**POST /refund**
```json
{
  "payment_id": 1,
  "amount": 100
}
```
Ответ:
```json
{
  "refund_id": "refund_1691234567890"
}
```

#### 4. Healthcheck
**GET /health**
```json
{
  "status": "ok"
}
```

## Примечания
- Планировщик автоматически обрабатывает все due-подписки и создаёт платежи.
- В случае неудачи платежа планируется повторная попытка через `RETRY_DELAY_SECONDS` (по умолчанию 1 день).
- Уведомления о статусе платежа отправляются в Telegram (если настроен) или выводятся в консоль.
- Для реальной интеграции с YooMoney реализуйте соответствующий класс в `app/gateway.py`.
- База данных SQLite создаётся автоматически (`payments.db`) и содержит таблицы `subscriptions` и `payments`. Можно просматривать через [DB Browser for SQLite](https://sqlitebrowser.org/).

---
**Проект готов к локальному тестированию и демонстрации функционала через Swagger UI.**


## Описание работы алгоритма

### 1. **Создание подписки (`/subscribe`)**
Пользователь отправляет запрос с суммой, валютой и интервалом.  
В базе данных создаётся новая запись подписки (`Subscription`) со следующими полями:
- `user_id` — идентификатор пользователя  
- `amount`, `currency` — сумма и валюта платежа  
- `next_run` — дата следующего списания (по умолчанию текущее время)  
- `active` — флаг активности подписки  

После создания подписка добавляется в очередь на обработку планировщиком.

---

### 2. **Планировщик (`scheduler.py`)**
При запуске приложения стартует фоновый процесс, который каждые  
`SCHEDULER_INTERVAL_SECONDS` секунд проверяет активные подписки.  
Если у подписки `next_run` ≤ текущей даты, то вызывается метод:
```python
process_subscription(subscription)
```

---

### 3. **Обработка подписки и проведение платежа (`gateway.py`)**
Для каждой подписки создаётся новый платёж (`Payment`), который проходит через платёжный шлюз (mock YooMoney).  
Гейтвей возвращает результат — успешный или неуспешный.

#### Возможные исходы:
- **Успешный платёж**
- 
  - статус платежа → `succeeded`
  - дата `next_run` обновляется на +N дней (`interval_days`)
  - пользователю отправляется уведомление о списании  
- **Ошибка платежа**
- 
  - статус платежа → `failed`
  - сохраняется причина (`failure_reason`)
  - планируется повтор через `RETRY_DELAY_SECONDS` (по умолчанию 1 день)
  - пользователю отправляется уведомление о неудаче

---

### 4. **Рекуррентные платежи (повторные попытки)**
Если предыдущая попытка платежа не удалась,  
система автоматически выполнит повтор через день.  
При каждой новой попытке увеличивается поле `attempts`,  
чтобы можно было отслеживать количество неудачных попыток.

---

### 5. **Возврат платежа (`/refund`)**
Любой успешный платёж можно вернуть вручную через API.  
Пример запроса:
```json
{
  "payment_id": 1,
  "amount": 100
}
```
В mock-режиме возврат просто эмулируется,  
но в реальной интеграции здесь будет запрос к API YooMoney.

---

### 6. **Уведомления (`notifier.py`)**
После каждого платежного события (успех или ошибка)  
отправляется уведомление в Telegram или консоль.  
Формат уведомления:
```
Успешный платёж

Подписка #1
Сумма: 100 RUB
Следующее списание: 2025-11-10
```
Если платёж не прошёл:
```
Неудачный платёж

Подписка #1
Причина: Недостаточно средств
Повторная попытка через 1 день
```

---

### 7. **Хранение данных (`payments.db`)**
Проект использует базу данных SQLite:
- `subscriptions` — хранит информацию о подписках  
- `payments` — хранит историю платежей и статусы  

Файл `payments.db` создаётся автоматически при первом запуске  
и может быть открыт через [DB Browser for SQLite](https://sqlitebrowser.org/)  
или просмотрен напрямую через Python ORM-запросы.

